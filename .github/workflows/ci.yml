name: CI
run-name: ${{ github.event.workflow_run.head_commit.message }}

on:
  pull_request:
    branches: [main, 5.x]
  push:
    branches: [main, 5.x]
  merge_group:
    branches: [main, 5.x]
  workflow_dispatch:
    inputs:
      publish_canary:
        description: 'Publish canary release after CI passes'
        required: false
        type: boolean
        default: false
      package:
        description: 'Package to release (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - '@iress-oss/ids-components'
          - '@iress-oss/ids-mcp-server'
          - '@iress-oss/ids-storybook-config'
          - '@iress-oss/ids-storybook-okta'
          - '@iress-oss/ids-storybook-sandbox'
          - '@iress-oss/ids-storybook-toggle-stories'
          - '@iress-oss/ids-storybook-version-badge'
          - '@iress-oss/ids-tokens'

permissions:
  id-token: write
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  YARN_VERSION: '4.10.3'
  INSTALL_CACHE_PATHS: |
    .yarn/cache
    .yarn/unplugged
    node_modules
    packages/*/node_modules
  BUILD_CACHE_PATHS: |
    packages/*/dist
    packages/components/src/styled-system
    packages/tokens/src/generated

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      yarn-cache-install-hit: ${{ steps.yarn-cache.outputs.cache-hit }}
      yarn-cache-build-hit: ${{ steps.yarn-cache-build.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Cache Yarn dependencies
        id: yarn-cache
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-
      - name: Cache Yarn build
        id: yarn-cache-build
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            yarn-${{ runner.os }}-
      - name: Install dependencies
        run: yarn install --immutable
      - name: Build dependencies
        if: steps.yarn-cache-build.outputs.cache-hit != 'true'
        run: yarn build

  validate:
    name: Validate
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        check: [lint, typecheck, test:ci]
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
      - name: Install the correct dependencies
        run: yarn install --immutable
      - name: Run ${{ matrix.check }}
        run: |
          if [ "${{ matrix.check }}" = "test:ci" ]; then
            # Tests with retry logic
            MAX_ATTEMPTS=3
            ATTEMPT=1
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ðŸ§ª Test attempt $ATTEMPT of $MAX_ATTEMPTS..."
              
              if yarn test:ci; then
                echo "âœ… Tests passed on attempt $ATTEMPT"
                exit 0
              else
                if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                  echo "âŒ Tests failed after $MAX_ATTEMPTS attempts"
                  exit 1
                fi
                
                echo "âš ï¸ Tests failed on attempt $ATTEMPT. Retrying in 30 seconds..."
                sleep 5
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done
          else
            # Run other checks normally (lint, typecheck) without retry
            yarn ${{ matrix.check }}
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-output
          path: |
            packages/*/dist/
          retention-days: 7

  chromatic:
    name: Chromatic (${{ matrix.package }})
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        include:
          - package: root
            token: CHROMATIC_ROOT_PROJECT_TOKEN
            dir: .
          - package: components
            token: CHROMATIC_COMPONENTS_PROJECT_TOKEN
            dir: packages/components
          - package: tokens
            token: CHROMATIC_TOKENS_PROJECT_TOKEN
            dir: packages/tokens
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
      - name: Install the correct dependencies
        run: yarn install --immutable
      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets[matrix.token] }}
          workingDir: ${{ matrix.dir }}
          buildScriptName: build-storybook
          onlyChanged: true
          autoAcceptChanges: '{main,5.x}'
          exitZeroOnChanges: true
          exitOnceUploaded: true

  validated:
    name: Validated
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: All validate jobs passed âœ…
        run: echo "âœ… All lint, typecheck, and test jobs passed."

  canary:
    name: Canary Release
    if: |
      github.repository_owner == 'iress' && (
        (github.event_name == 'workflow_dispatch' && inputs.publish_canary == true) ||
        (github.event_name == 'pull_request' && contains(github.event.head_commit.message, '[canary'))
      )
    runs-on: ubuntu-latest
    needs: [validated, build]
    environment: npm-publishing
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}

      - name: Install dependencies
        run: yarn install --immutable

      - name: Extract Package from Commit Message
        id: extract-package
        if: github.event_name == 'pull_request'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"

          # Extract package name from [canary:package-name] pattern
          if echo "$COMMIT_MSG" | grep -q '\[canary:'; then
            PACKAGE=$(echo "$COMMIT_MSG" | grep -oP '\[canary:\K[^\]]+' || echo "")
            if [ -n "$PACKAGE" ]; then
              echo "package=$PACKAGE" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Extracted package from commit: $PACKAGE"
            else
              echo "package=" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ No package specified, will publish all packages"
            fi
          else
            echo "package=" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ [canary] without package specified, will publish all packages"
          fi

      - name: Version Packages (Canary)
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          SHORT_SHA=${GITHUB_SHA:0:7}
          CANARY_VERSION="0.0.0-canary-${TIMESTAMP}-${SHORT_SHA}"

          # Determine which package to version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_PACKAGE="${{ github.event.inputs.package }}"
          else
            TARGET_PACKAGE="${{ steps.extract-package.outputs.package }}"
          fi

          echo "ðŸ“Œ Canary version: $CANARY_VERSION for branch: ${{ github.ref_name }}"

          if [ -n "$TARGET_PACKAGE" ]; then
            echo "ðŸ“¦ Versioning package: $TARGET_PACKAGE"
            yarn workspace "$TARGET_PACKAGE" version $CANARY_VERSION
          else
            echo "ðŸ“¦ Versioning all packages"
            yarn workspaces foreach -A --no-private version $CANARY_VERSION
          fi

      - name: Configure npm authentication for OIDC
        run: |
          echo 'npmRegistries:' >> .yarnrc.yml
          echo '  "https://registry.npmjs.org":' >> .yarnrc.yml
          echo '    npmAuthToken: "${NODE_AUTH_TOKEN}"' >> .yarnrc.yml

      - name: Publish to NPM (Canary)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Determine which package to publish
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_PACKAGE="${{ github.event.inputs.package }}"
          else
            TARGET_PACKAGE="${{ steps.extract-package.outputs.package }}"
          fi

          if [ -n "$TARGET_PACKAGE" ]; then
            echo "ðŸ“¦ Publishing package: $TARGET_PACKAGE"
            yarn workspace "$TARGET_PACKAGE" npm publish --tag canary --access public
          else
            echo "ðŸ“¦ Publishing all packages"
            yarn workspaces foreach -A --no-private npm publish --tag canary --access public
          fi
          echo "âœ… Canary release published successfully!"
