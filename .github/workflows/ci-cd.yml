name: CI/CD
run-name: ${{ github.event.head_commit.message || github.event.pull_request.title || github.ref_name }}

on:
  push:
    branches: ['**']
  merge_group:
    branches: [main, 5.x]
  workflow_dispatch:
    inputs:
      publish_canary:
        description: 'Publish canary release'
        required: false
        type: boolean
        default: false
      package:
        description: 'Package to release (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - '@iress-oss/ids-components'
          - '@iress-oss/ids-mcp-server'
          - '@iress-oss/ids-storybook-config'
          - '@iress-oss/ids-storybook-okta'
          - '@iress-oss/ids-storybook-sandbox'
          - '@iress-oss/ids-storybook-toggle-stories'
          - '@iress-oss/ids-storybook-version-badge'
          - '@iress-oss/ids-tokens'

permissions:
  id-token: write
  contents: write
  actions: read

# Conflicts with merge_group events
# concurrency:
#   group: ${{ github.workflow }}-${{ github.ref }}
#   cancel-in-progress: true

env:
  NODE_VERSION: '22'
  YARN_VERSION: '4.10.3'
  INSTALL_CACHE_PATHS: |
    .yarn/cache
    .yarn/unplugged
    node_modules
    packages/*/node_modules
  BUILD_CACHE_PATHS: |
    packages/*/dist
    packages/components/src/styled-system
    packages/tokens/src/generated

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Cache Yarn dependencies
        id: yarn-cache
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Cache Yarn build
        id: yarn-cache-build
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
      - name: Install dependencies
        run: yarn install --immutable
      - name: Build dependencies
        if: steps.yarn-cache-build.outputs.cache-hit != 'true'
        run: yarn build

  validate:
    name: Validate
    runs-on: ${{ matrix.check == 'lint:mermaid' && 'ubuntu-24.04' || 'ubuntu-latest' }}
    needs: setup
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        check: [lint, typecheck, test:ci, lint:mermaid]
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          fail-on-cache-miss: true
      - name: Restore build outputs
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
          fail-on-cache-miss: true
      - name: Install dependencies if needed
        run: yarn install --immutable
      - name: Install Chromium for Mermaid linting
        if: matrix.check == 'lint:mermaid'
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
      - name: Run ${{ matrix.check }}
        env:
          PUPPETEER_EXECUTABLE_PATH: '/usr/bin/chromium-browser'
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
        run: |
          if [ "${{ matrix.check }}" = "test:ci" ]; then
            # Tests with retry logic for flaky tests
            MAX_ATTEMPTS=3
            ATTEMPT=1
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ðŸ§ª Test attempt $ATTEMPT of $MAX_ATTEMPTS..."
              
              if yarn test:ci; then
                echo "âœ… Tests passed on attempt $ATTEMPT"
                exit 0
              else
                EXIT_CODE=$?
                if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                  echo "âŒ Tests failed after $MAX_ATTEMPTS attempts (exit code: $EXIT_CODE)"
                  exit $EXIT_CODE
                fi
                
                echo "âš ï¸ Tests failed on attempt $ATTEMPT (exit code: $EXIT_CODE). Retrying in 5 seconds..."
                sleep 5
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done
          else
            # Run other checks normally (lint, typecheck, lint:mermaid) without retry
            yarn ${{ matrix.check }}
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          fail-on-cache-miss: true
      - name: Restore build outputs
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
          fail-on-cache-miss: true
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-output
          path: |
            packages/*/dist/
          retention-days: 7
          if-no-files-found: warn

  chromatic:
    name: Chromatic (${{ matrix.package }})
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 20
    permissions:
      contents: read
      actions: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: root
            token: CHROMATIC_ROOT_PROJECT_TOKEN
            dir: .
          - package: components
            token: CHROMATIC_COMPONENTS_PROJECT_TOKEN
            dir: packages/components
          - package: tokens
            token: CHROMATIC_TOKENS_PROJECT_TOKEN
            dir: packages/tokens
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          fail-on-cache-miss: true
      - name: Restore build outputs
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
          fail-on-cache-miss: true
      - name: Install dependencies if needed
        run: yarn install --immutable
      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets[matrix.token] }}
          workingDir: ${{ matrix.dir }}
          buildScriptName: build-storybook
          onlyChanged: true
          autoAcceptChanges: '{main,5.x}'
          exitZeroOnChanges: true
          exitOnceUploaded: true

  validated:
    name: Validated
    runs-on: ubuntu-latest
    needs: [validate, chromatic]
    timeout-minutes: 5
    steps:
      - name: All validation jobs passed âœ…
        run: echo "âœ… All lint, typecheck, test, and Chromatic jobs passed."

  stable-release:
    name: Stable Release
    if: github.repository_owner == 'iress' && github.event_name == 'push' && contains(fromJSON('["refs/heads/main", "refs/heads/5.x"]'), github.ref)
    runs-on: ubuntu-latest
    needs: [validated, build]
    timeout-minutes: 15
    environment: npm-publishing
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Restore Yarn dependencies
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          fail-on-cache-miss: true

      - name: Restore build outputs
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Install dependencies if needed
        run: yarn install --immutable

      - name: Configure npm authentication for OIDC
        run: |
          echo 'npmRegistries:' >> .yarnrc.yml
          echo '  "https://registry.npmjs.org":' >> .yarnrc.yml
          echo '    npmAuthToken: "${NODE_AUTH_TOKEN}"' >> .yarnrc.yml

      - name: Detect Version Changes (Stable)
        id: version-check
        run: |
          chmod +x .github/scripts/publish-packages.sh
          .github/scripts/publish-packages.sh stable

      - name: Publish to NPM (Stable)
        if: steps.version-check.outputs.has_version_changes == 'true'
        id: publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PACKAGES="${{ steps.version-check.outputs.packages_to_publish }}"
          echo "Publishing packages: $PACKAGES"
          RELEASE_INFO=""
          for PACKAGE in $PACKAGES; do
            echo "Publishing $PACKAGE..."
            PKG_PATH=$(yarn workspaces list --json | jq -r "select(.name == \"$PACKAGE\") | .location")
            PKG_FILE="$PKG_PATH/package.json"
            VERSION=$(jq -r '.version' "$PKG_FILE")
            echo "  Version: $VERSION"
            if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-([a-zA-Z]+) ]]; then
              NPM_TAG="${BASH_REMATCH[1]}"
              IS_PRERELEASE="true"
              echo "  NPM Tag: $NPM_TAG (prerelease)"
            else
              NPM_TAG="latest"
              IS_PRERELEASE="false"
              echo "  NPM Tag: $NPM_TAG (stable)"
            fi
            yarn workspace "$PACKAGE" npm publish --tag "$NPM_TAG" --access public --provenance
            echo "  âœ… Published $PACKAGE@$VERSION with tag '$NPM_TAG'"
            RELEASE_INFO="${RELEASE_INFO}${PACKAGE}|${VERSION}|${IS_PRERELEASE};"
          done
          echo "âœ… All packages published successfully"
          echo "release_info=$RELEASE_INFO" >> $GITHUB_OUTPUT

      # Doesn't work as we don't have access to create releases
      # - name: Create GitHub Releases
      #   if: steps.version-check.outputs.has_version_changes == 'true'
      #   env:
      #     GH_TOKEN: ${{ github.token }}
      #   run: |
      #     chmod +x .github/scripts/create-releases.sh
      #     .github/scripts/create-releases.sh "${{ steps.publish.outputs.release_info }}"

  canary:
    name: Canary Release
    if: github.repository_owner == 'iress' && !contains(fromJSON('["refs/heads/main", "refs/heads/5.x"]'), github.ref) && (github.event_name == 'workflow_dispatch' && inputs.publish_canary == true || github.event_name == 'push' && contains(github.event.head_commit.message, '[canary'))
    runs-on: ubuntu-latest
    needs: [validated, build]
    timeout-minutes: 15
    environment: npm-publishing
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Restore Yarn dependencies
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          fail-on-cache-miss: true

      - name: Restore build outputs
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
          fail-on-cache-miss: true

      - name: Install dependencies if needed
        run: yarn install --immutable

      - name: Extract Package from Commit Message
        id: extract-package
        if: github.event_name == 'push'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"

          # Extract package name from [canary:package-name] pattern, if present
          if [[ "$COMMIT_MSG" =~ \[canary:([^\]]+)\] ]]; then
            PACKAGE="${BASH_REMATCH[1]}"
            echo "package=$PACKAGE" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Extracted package: $PACKAGE"
          else
            echo "package=" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ No specific package in [canary:package] format, will publish all packages"
          fi

      - name: Version Packages (Canary)
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          SHORT_SHA=${GITHUB_SHA:0:7}
          CANARY_VERSION="0.0.0-canary-${TIMESTAMP}-${SHORT_SHA}"

          # Determine which package to version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_PACKAGE="${{ github.event.inputs.package }}"
          else
            TARGET_PACKAGE="${{ steps.extract-package.outputs.package }}"
          fi

          echo "ðŸ“Œ Canary version: $CANARY_VERSION for branch: ${{ github.ref_name }}"

          if [ -n "$TARGET_PACKAGE" ]; then
            echo "ðŸ“¦ Versioning package: $TARGET_PACKAGE"
            yarn workspace "$TARGET_PACKAGE" version $CANARY_VERSION
          else
            echo "ðŸ“¦ Versioning all packages"
            yarn workspaces foreach -A --no-private version $CANARY_VERSION
          fi

      - name: Configure npm authentication for OIDC
        run: |
          echo 'npmRegistries:' >> .yarnrc.yml
          echo '  "https://registry.npmjs.org":' >> .yarnrc.yml
          echo '    npmAuthToken: "${NODE_AUTH_TOKEN}"' >> .yarnrc.yml

      - name: Publish to NPM (Canary)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Determine which package to publish
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_PACKAGE="${{ github.event.inputs.package }}"
          else
            TARGET_PACKAGE="${{ steps.extract-package.outputs.package }}"
          fi

          if [ -n "$TARGET_PACKAGE" ]; then
            echo "ðŸ“¦ Publishing package: $TARGET_PACKAGE"
            yarn workspace "$TARGET_PACKAGE" npm publish --tag canary --access public
          else
            echo "ðŸ“¦ Publishing all packages"
            yarn workspaces foreach -A --no-private npm publish --tag canary --access public
          fi
          echo "âœ… Canary release published successfully!"
