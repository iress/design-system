name: CI/CD
run-name: ${{ github.event.head_commit.message || github.event.pull_request.title || github.ref_name }}

on:
  push:
    branches: ['**']
  merge_group:
    branches: [main, 5.x]
  workflow_dispatch:
    inputs:
      publish_canary:
        description: 'Publish canary release'
        required: false
        type: boolean
        default: false
      package:
        description: 'Package to release (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - '@iress-oss/ids-components'
          - '@iress-oss/ids-mcp-server'
          - '@iress-oss/ids-storybook-config'
          - '@iress-oss/ids-storybook-okta'
          - '@iress-oss/ids-storybook-sandbox'
          - '@iress-oss/ids-storybook-toggle-stories'
          - '@iress-oss/ids-storybook-version-badge'
          - '@iress-oss/ids-tokens'

permissions:
  id-token: write
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

env:
  NODE_VERSION: '22'
  YARN_VERSION: '4.10.3'
  INSTALL_CACHE_PATHS: |
    .yarn/cache
    .yarn/unplugged
    node_modules
    packages/*/node_modules
  BUILD_CACHE_PATHS: |
    packages/*/dist
    packages/components/src/styled-system
    packages/tokens/src/generated

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      yarn-cache-install-hit: ${{ steps.yarn-cache.outputs.cache-hit }}
      yarn-cache-build-hit: ${{ steps.yarn-cache-build.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Cache Yarn dependencies
        id: yarn-cache
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-
      - name: Cache Yarn build
        id: yarn-cache-build
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
          restore-keys: |
            yarn-${{ runner.os }}-
      - name: Install dependencies
        run: yarn install --immutable
      - name: Build dependencies
        if: steps.yarn-cache-build.outputs.cache-hit != 'true'
        run: yarn build

  validate:
    name: Validate
    runs-on: ${{ matrix.check == 'lint:mermaid' && 'ubuntu-24.04' || 'ubuntu-latest' }}
    needs: setup
    strategy:
      matrix:
        check: [lint, typecheck, test:ci, lint:mermaid]
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
      - name: Install the correct dependencies
        run: yarn install --immutable
      - name: Cache Chromium
        if: matrix.check == 'lint:mermaid'
        uses: actions/cache@v4
        id: chromium-cache
        with:
          path: |
            /usr/bin/chromium-browser
            /usr/lib/chromium-browser
          key: chromium-${{ runner.os }}-ubuntu-24.04
      - name: Install Chromium for Mermaid linting
        if: matrix.check == 'lint:mermaid' && steps.chromium-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
      - name: Run ${{ matrix.check }}
        env:
          PUPPETEER_EXECUTABLE_PATH: '/usr/bin/chromium-browser'
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
        run: |
          if [ "${{ matrix.check }}" = "test:ci" ]; then
            # Tests with retry logic
            MAX_ATTEMPTS=3
            ATTEMPT=1
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "ðŸ§ª Test attempt $ATTEMPT of $MAX_ATTEMPTS..."
              
              if yarn test:ci; then
                echo "âœ… Tests passed on attempt $ATTEMPT"
                exit 0
              else
                if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                  echo "âŒ Tests failed after $MAX_ATTEMPTS attempts"
                  exit 1
                fi
                
                echo "âš ï¸ Tests failed on attempt $ATTEMPT. Retrying in 30 seconds..."
                sleep 5
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done
          else
            # Run other checks normally (lint, typecheck) without retry
            yarn ${{ matrix.check }}
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-output
          path: |
            packages/*/dist/
          retention-days: 7

  chromatic:
    name: Chromatic (${{ matrix.package }})
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        include:
          - package: root
            token: CHROMATIC_ROOT_PROJECT_TOKEN
            dir: .
          - package: components
            token: CHROMATIC_COMPONENTS_PROJECT_TOKEN
            dir: packages/components
          - package: tokens
            token: CHROMATIC_TOKENS_PROJECT_TOKEN
            dir: packages/tokens
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable Corepack
        run: corepack enable
      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}
      - name: Install the correct dependencies
        run: yarn install --immutable
      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets[matrix.token] }}
          workingDir: ${{ matrix.dir }}
          buildScriptName: build-storybook
          onlyChanged: true
          autoAcceptChanges: '{main,5.x}'
          exitZeroOnChanges: true
          exitOnceUploaded: true

  validated:
    name: Validated
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: All validate jobs passed âœ…
        run: echo "âœ… All lint, typecheck, and test jobs passed."

  stable-release:
    name: Stable Release
    if: github.repository_owner == 'iress' && github.event_name == 'push' && contains(fromJSON('["refs/heads/main", "refs/heads/5.x"]'), github.ref)
    runs-on: ubuntu-latest
    needs: [validated, build]
    environment: npm-publishing
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}

      - name: Install dependencies
        run: yarn install --immutable

      - name: Configure npm authentication for OIDC
        run: |
          echo 'npmRegistries:' >> .yarnrc.yml
          echo '  "https://registry.npmjs.org":' >> .yarnrc.yml
          echo '    npmAuthToken: "${NODE_AUTH_TOKEN}"' >> .yarnrc.yml

      - name: Detect Version Changes (Stable)
        id: version-check
        run: |
          chmod +x .github/scripts/publish-packages.sh
          .github/scripts/publish-packages.sh stable

      - name: Publish to NPM (Stable)
        if: steps.version-check.outputs.has_version_changes == 'true'
        id: publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PACKAGES="${{ steps.version-check.outputs.packages_to_publish }}"
          echo "Publishing packages: $PACKAGES"
          RELEASE_INFO=""
          for PACKAGE in $PACKAGES; do
            echo "Publishing $PACKAGE..."
            PKG_PATH=$(yarn workspaces list --json | jq -r "select(.name == \"$PACKAGE\") | .location")
            PKG_FILE="$PKG_PATH/package.json"
            VERSION=$(jq -r '.version' "$PKG_FILE")
            echo "  Version: $VERSION"
            if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-([a-zA-Z]+) ]]; then
              NPM_TAG="${BASH_REMATCH[1]}"
              IS_PRERELEASE="true"
              echo "  NPM Tag: $NPM_TAG (prerelease)"
            else
              NPM_TAG="latest"
              IS_PRERELEASE="false"
              echo "  NPM Tag: $NPM_TAG (stable)"
            fi
            yarn workspace "$PACKAGE" npm publish --tag "$NPM_TAG" --access public --provenance
            echo "  âœ… Published $PACKAGE@$VERSION with tag '$NPM_TAG'"
            RELEASE_INFO="${RELEASE_INFO}${PACKAGE}|${VERSION}|${IS_PRERELEASE};"
          done
          echo "âœ… All packages published successfully"
          echo "release_info=$RELEASE_INFO" >> $GITHUB_OUTPUT

      - name: Create GitHub Releases
        if: steps.version-check.outputs.has_version_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x .github/scripts/create-releases.sh
          .github/scripts/create-releases.sh "${{ steps.publish.outputs.release_info }}"

  canary:
    name: Canary Release
    if: github.repository_owner == 'iress' && (github.event_name == 'workflow_dispatch' && inputs.publish_canary == true || github.event_name == 'push' && contains(github.event.head_commit.message, '[canary'))
    runs-on: ubuntu-latest
    needs: [validated, build]
    environment: npm-publishing
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Restore Yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.INSTALL_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}

      - name: Restore build outputs
        uses: actions/cache@v4
        with:
          path: ${{ env.BUILD_CACHE_PATHS }}
          key: yarn-${{ runner.os }}-${{ github.run_id }}

      - name: Install dependencies
        run: yarn install --immutable

      - name: Extract Package from Commit Message
        id: extract-package
        if: github.event_name == 'push'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"

          # Check if [canary] tag exists
          if echo "$COMMIT_MSG" | grep -q '\[canary'; then
            echo "has_canary=true" >> $GITHUB_OUTPUT
            
            # Extract package name from [canary:package-name] pattern
            if echo "$COMMIT_MSG" | grep -q '\[canary:'; then
              PACKAGE=$(echo "$COMMIT_MSG" | grep -oP '\[canary:\K[^\]]+' || echo "")
              if [ -n "$PACKAGE" ]; then
                echo "package=$PACKAGE" >> $GITHUB_OUTPUT
                echo "ðŸ“¦ Extracted package: $PACKAGE"
              else
                echo "package=" >> $GITHUB_OUTPUT
                echo "ðŸ“¦ No package specified, will publish all packages"
              fi
            else
              echo "package=" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ [canary] without package specified, will publish all packages"
            fi
          else
            echo "has_canary=false" >> $GITHUB_OUTPUT
            echo "package=" >> $GITHUB_OUTPUT
            echo "â­ï¸ No [canary] tag found, skipping canary release"
          fi

      - name: Version Packages (Canary)
        if: github.event_name == 'workflow_dispatch' || steps.extract-package.outputs.has_canary == 'true'
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          SHORT_SHA=${GITHUB_SHA:0:7}
          CANARY_VERSION="0.0.0-canary-${TIMESTAMP}-${SHORT_SHA}"

          # Determine which package to version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_PACKAGE="${{ github.event.inputs.package }}"
          else
            TARGET_PACKAGE="${{ steps.extract-package.outputs.package }}"
          fi

          echo "ðŸ“Œ Canary version: $CANARY_VERSION for branch: ${{ github.ref_name }}"

          if [ -n "$TARGET_PACKAGE" ]; then
            echo "ðŸ“¦ Versioning package: $TARGET_PACKAGE"
            yarn workspace "$TARGET_PACKAGE" version $CANARY_VERSION
          else
            echo "ðŸ“¦ Versioning all packages"
            yarn workspaces foreach -A --no-private version $CANARY_VERSION
          fi

      - name: Configure npm authentication for OIDC
        if: github.event_name == 'workflow_dispatch' || steps.extract-package.outputs.has_canary == 'true'
        run: |
          echo 'npmRegistries:' >> .yarnrc.yml
          echo '  "https://registry.npmjs.org":' >> .yarnrc.yml
          echo '    npmAuthToken: "${NODE_AUTH_TOKEN}"' >> .yarnrc.yml

      - name: Publish to NPM (Canary)
        if: github.event_name == 'workflow_dispatch' || steps.extract-package.outputs.has_canary == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Determine which package to publish
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_PACKAGE="${{ github.event.inputs.package }}"
          else
            TARGET_PACKAGE="${{ steps.extract-package.outputs.package }}"
          fi

          if [ -n "$TARGET_PACKAGE" ]; then
            echo "ðŸ“¦ Publishing package: $TARGET_PACKAGE"
            yarn workspace "$TARGET_PACKAGE" npm publish --tag canary --access public
          else
            echo "ðŸ“¦ Publishing all packages"
            yarn workspaces foreach -A --no-private npm publish --tag canary --access public
          fi
          echo "âœ… Canary release published successfully!"
