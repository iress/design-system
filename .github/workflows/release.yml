name: Release
run-name: ${{ github.event.workflow_run.head_commit.message }}

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches:
      - main
      - 5.x

permissions:
  id-token: write
  contents: write
  actions: read

env:
  NODE_VERSION: '22'
  YARN_VERSION: '4.10.3'

jobs:
  packages:
    name: Packages
    if: github.repository_owner == 'iress' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    environment: npm-publishing
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build

      - name: Configure npm authentication for OIDC
        run: |
          echo 'npmRegistries:' >> .yarnrc.yml
          echo '  "https://registry.npmjs.org":' >> .yarnrc.yml
          echo '    npmAuthToken: "${NODE_AUTH_TOKEN}"' >> .yarnrc.yml

      - name: Detect Version Changes (Stable)
        id: version-check
        run: |
          chmod +x .github/scripts/publish-packages.sh
          .github/scripts/publish-packages.sh stable

      - name: Publish to NPM (Stable)
        if: steps.version-check.outputs.has_version_changes == 'true'
        id: publish
        run: |
          PACKAGES="${{ steps.version-check.outputs.packages_to_publish }}"
          echo "Publishing packages: $PACKAGES"
          RELEASE_INFO=""
          for PACKAGE in $PACKAGES; do
            echo "Publishing $PACKAGE..."
            PKG_PATH=$(yarn workspaces list --json | jq -r "select(.name == \"$PACKAGE\") | .location")
            PKG_FILE="$PKG_PATH/package.json"
            VERSION=$(jq -r '.version' "$PKG_FILE")
            echo "  Version: $VERSION"
            if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-([a-zA-Z]+) ]]; then
              NPM_TAG="${BASH_REMATCH[1]}"
              IS_PRERELEASE="true"
              echo "  NPM Tag: $NPM_TAG (prerelease)"
            else
              NPM_TAG="latest"
              IS_PRERELEASE="false"
              echo "  NPM Tag: $NPM_TAG (stable)"
            fi
            yarn workspace "$PACKAGE" npm publish --tag "$NPM_TAG" --access public --provenance
            echo "  ✅ Published $PACKAGE@$VERSION with tag '$NPM_TAG'"
            RELEASE_INFO="${RELEASE_INFO}${PACKAGE}|${VERSION}|${IS_PRERELEASE};"
          done
          echo "✅ All packages published successfully"
          echo "release_info=$RELEASE_INFO" >> $GITHUB_OUTPUT

      - name: Create GitHub Releases
        if: steps.version-check.outputs.has_version_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x .github/scripts/create-releases.sh
          .github/scripts/create-releases.sh "${{ steps.publish.outputs.release_info }}"
