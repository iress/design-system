name: Publish
run-name: ${{ github.event_name == 'workflow_dispatch' && format('{0} (canary) by @{1}', inputs.package || 'all packages', github.actor) || github.event.workflow_run.head_commit.message }}

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to release (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - '@iress-oss/ids-components'
          - '@iress-oss/ids-mcp-server'
          - '@iress-oss/ids-storybook-config'
          - '@iress-oss/ids-storybook-okta'
          - '@iress-oss/ids-storybook-sandbox'
          - '@iress-oss/ids-storybook-toggle-stories'
          - '@iress-oss/ids-storybook-version-badge'
          - '@iress-oss/ids-tokens'
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches:
      - main
      - 5.x

permissions:
  id-token: write
  contents: write
  actions: read

env:
  NODE_VERSION: '22'
  YARN_VERSION: '4.10.3'

jobs:
  packages:
    name: Packages
    if: github.repository_owner == 'iress'
    runs-on:
      group: wealth-actions-runners
    environment: npm-publishing
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine Release Type
        id: release-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=canary" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Canary release triggered manually from branch: ${{ github.ref_name }}"
          else
            echo "type=stable" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Stable release triggered from CI on branch: ${{ github.ref_name }}"
          fi

      - name: Check CI Status (Stable)
        if: steps.release-type.outputs.type == 'stable'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ CI workflow did not succeed. Skipping release."
            exit 1
          fi
          echo "âœ… CI workflow passed. Proceeding with stable release."

      - name: Check CI Status (Canary)
        if: steps.release-type.outputs.type == 'canary'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking CI workflow status for branch: ${{ github.ref_name }}"
          CI_STATUS=$(gh run list --workflow=ci.yml --branch=${{ github.ref_name }} --json conclusion --limit 1 --jq '.[0].conclusion')
          echo "Latest CI status: $CI_STATUS"
          if [ "$CI_STATUS" != "success" ]; then
            echo "âŒ CI workflow has not passed on this branch. Cannot publish canary release."
            exit 1
          fi
          echo "âœ… CI workflow passed. Proceeding with canary release."

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build

      - name: Version Packages (Canary)
        if: steps.release-type.outputs.type == 'canary'
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          SHORT_SHA=${GITHUB_SHA:0:7}
          CANARY_VERSION="0.0.0-canary.${TIMESTAMP}-${SHORT_SHA}"
          echo "ðŸ“Œ Canary version: $CANARY_VERSION"
          if [ "${{ github.event.inputs.package }}" != "" ]; then
            yarn workspace ${{ github.event.inputs.package }} version $CANARY_VERSION
          else
            yarn workspaces foreach -A --no-private version $CANARY_VERSION
          fi

      - name: Configure npm authentication for OIDC
        run: |
          echo 'npmRegistries:' >> .yarnrc.yml
          echo '  "https://registry.npmjs.org":' >> .yarnrc.yml
          echo '    npmAuthToken: "${NODE_AUTH_TOKEN}"' >> .yarnrc.yml

      - name: Detect Version Changes (Stable)
        if: steps.release-type.outputs.type == 'stable'
        id: version-check
        run: |
          chmod +x .github/scripts/publish-packages.sh
          .github/scripts/publish-packages.sh stable

      - name: Publish to NPM (Canary)
        if: steps.release-type.outputs.type == 'canary'
        run: |
          if [ "${{ github.event.inputs.package }}" != "" ]; then
            yarn workspace ${{ github.event.inputs.package }} npm publish --tag canary --access public --provenance
          else
            yarn workspaces foreach -A --no-private npm publish --tag canary --access public --provenance
          fi

      - name: Publish to NPM (Stable)
        if: steps.release-type.outputs.type == 'stable' && steps.version-check.outputs.has_version_changes == 'true'
        id: publish
        run: |
          PACKAGES="${{ steps.version-check.outputs.packages_to_publish }}"
          echo "Publishing packages: $PACKAGES"
          RELEASE_INFO=""
          for PACKAGE in $PACKAGES; do
            echo "Publishing $PACKAGE..."
            PKG_PATH=$(yarn workspaces list --json | jq -r "select(.name == \"$PACKAGE\") | .location")
            PKG_FILE="$PKG_PATH/package.json"
            VERSION=$(jq -r '.version' "$PKG_FILE")
            echo "  Version: $VERSION"
            if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-([a-zA-Z]+) ]]; then
              NPM_TAG="${BASH_REMATCH[1]}"
              IS_PRERELEASE="true"
              echo "  NPM Tag: $NPM_TAG (prerelease)"
            else
              NPM_TAG="latest"
              IS_PRERELEASE="false"
              echo "  NPM Tag: $NPM_TAG (stable)"
            fi
            yarn workspace "$PACKAGE" npm publish --tag "$NPM_TAG" --access public --provenance
            echo "  âœ… Published $PACKAGE@$VERSION with tag '$NPM_TAG'"
            RELEASE_INFO="${RELEASE_INFO}${PACKAGE}|${VERSION}|${IS_PRERELEASE};"
          done
          echo "âœ… All packages published successfully"
          echo "release_info=$RELEASE_INFO" >> $GITHUB_OUTPUT

      - name: Create GitHub Releases
        if: steps.release-type.outputs.type == 'stable' && steps.version-check.outputs.has_version_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x .github/scripts/create-releases.sh
          .github/scripts/create-releases.sh "${{ steps.publish.outputs.release_info }}"
